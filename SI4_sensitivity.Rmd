---
title: "Sensitivity analysis of the TROLL model in French Guiana"
output: 
  bookdown::word_document2:
    number_sections: false
    always_allow_html: true 
  bookdown::pdf_document2:
    toc: false
    number_sections: false 
  bookdown::html_document2:
    number_sections: false  
    toc: true
    toc_float: yes
linestretch: 1.5
csl: bibliography/mee.csl
bibliography: bibliography/library.bib
link-citations: yes
---

Guillaume Salzet$^{1,2}$ Sylvain Schmitt$^3$

$^1$ *INRAE, UMR BETA, 54042 Nancy, France;* $^2$ *INRAE, UMR EcoFoG (Agroparistech, Cirad, CNRS, Université des Antilles, Université de la Guyane), Campus Agronomique, 97310 Kourou, French Guiana;* $^3$ *CNRS, UMR EcoFoG (Agroparistech, Cirad, INRAE, Université des Antilles, Université de la Guyane), Campus Agronomique, 97310 Kourou, French Guiana*;

```{r include=TRUE, eval=FALSE}
# Data manipulation
library(tidyverse)
library(kableExtra)
# Parallel computing
library(doSNOW)
# TROLL simulator
library(rcontroll)
# Interpolation function
library(hetGP)
#Sensitivity analyses
library(sensobol)
library(sensitivity)
# Plotting
library(ggraph)
library(GGally)
library(ggrepel)
library(grid)
# Reproductibility
set.seed(42) 
```

# Introduction

Forest modelling aims to reproduce at a given scale of space and time emergent properties from sub-entities. Classically these entities in gap-models are cohorts of trees or for Dynamic Global Vegetation Models (DGVM) these are representative plant functional types. The underlying hypothesis is that small scale interactions among entities can reproduce global patterns. In case of TROLL this hypothesis is furthermore implied with the use of individual ecophysiological processes.

However, all previously cited model types rely on complex implementation and use a high level of computing resources to provide results at their designed scale. Working with such complex models create challenges:

1.  simulations are time consuming and require the use of High Performance Computers;

2.  model calibration is very complicated due to the uncertainty of the model's behaviour;

3.  calibration require two steps: a sensitivity analysis to select adapted parameters and a model inversion to select which parameters of the model are more likely to produce observed outputs;

4.  model calibration requires an assessment of the uncertainties produced by the model, which imply selecting methods that allow the use of a calibrated-model in a reverse and forward uncertainty propagation.

As proof of concept of interface between TROLL simulator and the R package ecosystem, we decide to interface TROLL through rcontroll and realise the first step for local calibration of the model : the sensitivity analysis.

The sensitivity analysis is composed of three steps: (1) sample design, (2) computation of outputs and (3) computation of indices. All these steps rely on available R packages and can be reproduced with this vignette.

All used function designed for this analysis are available in the R file:

:   SI5_calibration_functions.R

```{r calibration functions, echo=TRUE}
source("SI5_calibration_functions.R")

ls()
```

# Simulation experiment

To perform the sensitivity analysis, we selected a set of global parameters previously studied in @Marechaux2017, @Rau2022 and @fisherInferringStructureDynamics2019. The selected parameters are presented in the following table:

+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| **Processus**          | Parameters                                                                   | ***A priori*** interval | Source                                                             |
+:======================:+:============================================================================:+:=======================:+:==================================================================:+
| **Leaf ecophysiology** | $k_{light}$: light extinction coefficient (dimensionless)                    | [0.50, 0.95]            | [@Marechaux2017]                                                   |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| \-                     | $\Phi$ : apparent quantum yield for C fixation                               | [0.04, 0.09]            | \-                                                                 |
|                        |                                                                              |                         |                                                                    |
|                        | ($m o l~C .mo l~p ho tons^{-1}$)                                             |                         |                                                                    |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| \-                     | $g_{1}$: stomatal conductance parameter (kPa)                                | [2.00, 5.00]            | \-                                                                 |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| **Carbon allocation**  | $f_{wood}$ :fraction of NPP allocated to wood growth (%)                     | [0.01, 1.00]            | $f_{wood} + f_{canopy} + f_{leaf} = 1$                             |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| \-                     | $f_{canopy}$: fraction of NPP allocated to canopy (%)                        | [0.01, 1.00]            | \-                                                                 |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| **Mortality**          | $m_{0}$: maximal basal mortality rate                                        | [0.01, 0.05]            | [@fisherInferringStructureDynamics2019]                            |
|                        |                                                                              |                         |                                                                    |
|                        | ( $ev ent s. year^{-1}$)                                                     |                         |                                                                    |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| \-                     | $wsg_{lim}$: wood specific gravity limiting mortality factor (dimensionless) | [1.00, 1.20]            | [@Marechaux2017]                                                   |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| \-                     | $V_{c}$ : treefall stochastic threshold (dimensionless)                      | [0.01, 0.15]            | [@Rau2022]                                                         |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| **Reproduction**       | $seedrain$ : Total number of reproduction opportunities coming from outside  | [100, 100 000]          | [@Marechaux2017]                                                   |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| \-                     | $nbs_{0}$ : local seed dispersed par mature tree                             | [1, 1000]               | \-                                                                 |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| **Crown allometry**    | $CR_{a}$ : intercept of Log-Log regression to infer crown radius from DBH    | [1.5, 3]                | [@fisherInferringStructureDynamics2019] with a correlation factor: |
|                        |                                                                              |                         |                                                                    |
|                        |                                                                              |                         | $\rho = 0.65$                                                      |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+
| \-                     | $CR_{b}$ : slope of Log-Log regression to infer crown radius from DBH        | [0.4, 0.8]              | \-                                                                 |
+------------------------+------------------------------------------------------------------------------+-------------------------+--------------------------------------------------------------------+

: **Table 1:** Global parameters used for sensitivity analysis. Parameters have been classified by associated processes. The a priori interval used for sensitivity analysis is given for each parameter with its source.

## Sampling design

The first step is to define the sample design of the tested parameters. We defined bounded ranges for each parameter to test according to @Marechaux2017 (Table 1). The sampling design is optimised to maximise the minimal distance between sampling points in parameters hypercube using lhs package within the `Generate_LHS_Autocalib` function.

The hypercube of parameters is re-projected to match the a priori ranges and correlation factor previously described in table using Huntington-Lyrintzis algorithm @huntington1998 implemented in the pse R package [@pse].

```{r Standard_LHS, echo=FALSE, message=FALSE, warning=FALSE}
parameters <- c("klight","phi","g1","fallocwood","falloccanopy","m","vC","Cseedrain","log10nbs0","CR_a","CR_b","m1")
lower <- c(0.5,4E-2,2,1E-2,1E-2,1E-2,1E-2,1E2,0,1.5,0.4,1)
upper = c(0.95,9E-2,5,1,1,0.05,0.15,1E5,3,3,0.8,1.2) 
global_parameters_boundaries <- data.frame("parameter" = parameters,"lower" = lower,
                                           "upper" = upper)
```

```{r eval=FALSE, include=TRUE}
LHS_design <- Generate_LHS_Autocalib(nsim = 500,nreplicat = 10,paramLHS = global_parameters_boundaries,Nyears = 600,Nsampling = 100)

Generated_parameters <- Generate_parameters_autocalib(LHS_design = LHS_design)
```

## Computation of outputs

The second step is the computation of the variables of interest using the TROLL model within the `rcontroll` package.

Once the parameters were defined and optimised, we used the `stack` function of `rcontroll` within the `autocalibGP` function to simulate forests from the bare ground for 600 years with 10 replicates. An interpolation step is used for denoising the estimate to obtain the continuous mean response of a variable of interest over the parameters domain. The interpolation function is an heteroscedastic gaussian process function from the `hetGP` package. The main advantage of gaussian process functions is its high flexibility to fit noisy nonlinear functions [@binois2021].

```{r eval=FALSE, include=TRUE}
calib_dataset <- autocalibGP(Generated_parameters = Generated_parameters,
                             PATH = getwd(),
                             ncores_sim = 100,
                             ncores = 50,
                             NiterHetGP = NULL,
                             initj = 1,Jrefresh = 25,
                             GPComputation = TRUE)

save(calib_dataset, "rcontrollTROLL_calib_1000x10LHS_600y.rda")
```

We checked the estimation quality of the denoised mean response versus value from the simulations (*cf.* table 2).

```{r eval=FALSE, include=TRUE}
load("./data/rcontrollTROLL_calib_1000x10LHS_600y.rda")

tibble(index_params = c(2,6,8,10)) |> 
  rowwise() |> 
  do(cor_param = round(cor(calib_dataset$GPmodels[[.$index_params]][[2]]$Z0,LOO_preds(calib_dataset$GPmodels[[.$index_params]][[2]])$mean),
                       digits = 2),
     RMSE_param =  round(sqrt(sum( (calib_dataset$GPmodels[[.$index_params]][[2]]$Z0-LOO_preds(calib_dataset$GPmodels[[.$index_params]][[2]])$mean)^2 )/length(calib_dataset$GPmodels[[.$index_params]][[2]]$Z0) ),
                          digits = 2) ) |> 
  unnest(cols = c(cor_param, RMSE_param)) |> 
  mutate(parameters = colnames(calib_dataset$Y)[c(2,6,8,10)]) |> dplyr::select(parameters,cor_param,RMSE_param)|> kbl()
```

+----------------------------------------------------------------------------------------+-----------------------------+-------------------------------+
| Studied TROLL outputs                                                                  | Correlation factor ($\rho$) | Root Mean Square Error (RMSE) |
+:======================================================================================:+:===========================:+:=============================:+
| Above Ground Biomass $(\log(AGB+1)~.unitless)$                                         | 0.61                        | 0.72                          |
+----------------------------------------------------------------------------------------+-----------------------------+-------------------------------+
| Number of tree with a diameter at 1.30m height over 10 cm $(\log(N_{10}+1)~.unitless)$ | 0.78                        | 1.06                          |
+----------------------------------------------------------------------------------------+-----------------------------+-------------------------------+
| Number of tree with a diameter at 1.30m height over 30 cm $(\log(N_{30}+1)~.unitless)$ | 0.74                        | 0.90                          |
+----------------------------------------------------------------------------------------+-----------------------------+-------------------------------+
| Gross Primary Production $(GPP~MgC.ha^{-1})$                                           | 0.88                        | 0.35                          |
+----------------------------------------------------------------------------------------+-----------------------------+-------------------------------+

: **Table 2:** Quality check of gaussian processes interpolators for studied TROLL outputs

## Evaluation of sensitivity indices

The third step is the estimation of the sensitivity indices.

A first step is a qualitative approach with elementary effect analysis (Morris analysis) to screen which are the most influential variables for all outputs.

In a second time, the variance-based indices (Sobol indices) are computed for one output to explore marginal and interactions between variables on the output's variance.

The elementary effect and variance-based analyses are processed using `sensitivity` and `sensobol` packages.

### Elementary effects analysis

The Morris analysis is a qualitative analysis for screening or eliminating non-influential factors [@morris1991]. This method is also called the elementary effects method and relies on an one-step-at-a-time sampling design (i.e. in each run only one input parameter is given a new value). Therefore, it is possible to calculate the "elementary effect (EE)" of each parameter on the outputs, one by one, and finally evaluate the influence of all of them on the results. Finally, sensitivity factors can be compared globally and the non-linearity/interaction of the model can be described qualitatively.

For this Morris analysis we focused on same the model's outputs as @Marechaux2017:

-   $AGB$ Above Ground Biomass (including diameter at 1.30m height over 10 cm);

-   $N_{10}$ Number of tree with a diameter at 1.30m height over 10 cm;

-   $N_{30}$ Number of tree with a diameter at 1.30m height over 30 cm;

-   $GPP$ Gross primary production.

We use the `morris` function which implements an extension for multidimensional outputs @monari2016.

Following this method, the outputs are scaled to avoid biassed estimation

```{r FigA_Morris, eval=FALSE, fig.height=7, fig.width=7, message=FALSE, warning=FALSE, include=TRUE}

load("./data/rcontrollTROLL_calib_1000x10LHS_600y.rda")

morrisOut <- morris(
  model = NULL,
  factors = calib_dataset$params[c(1:9,11:13)],
  r = 100,
  design = list(type = "oat", levels = 20, grid.jump = 3),
  binf = 0.33,
  bsup = 0.66,
  scale = FALSE)

X <- cbind(morrisOut[['X']][,1:9], 
           matrix(0.5,nrow =dim(morrisOut[['X']])[1],ncol = 1),
           morrisOut[['X']][,10:12],
           matrix(0.5,nrow =dim(morrisOut[['X']])[1],ncol = 2))

Y <- matrix(c(scale(predict(calib_dataset$GPmodels$MeanAgb$mod.MeanAgb,X)$mean),
              scale(predict(calib_dataset$GPmodels$MeanSum10$mod.MeanSum10,X)$mean),
              scale(predict(calib_dataset$GPmodels$MeanSum30$mod.MeanSum30,X)$mean),
              scale(predict(calib_dataset$GPmodels$MeanGpp$mod.MeanGpp,X)$mean)), 
            ncol = 4, byrow = FALSE)

tell(morrisOut,Y)

# summarise the moris output
morrisOut.df <- data.frame(
  parameter = calib_dataset$params[c(1:9,11:13)],
  mu.star = apply(abs(morrisOut$ee), 2, mean, na.rm = T),
  sigma = apply(morrisOut$ee, 2, sd, na.rm = T)) |> 
  arrange( mu.star )

Morris_fig <- morrisOut.df|> as_tibble() |> 
  mutate(parameter_i = recode(parameter, 
                              "m" = "m[0]",
                              "CR_a" = "CR[a]",
                              "phi" = "Phi",
                              "fallocwood" = "f[wood]",
                              "falloccanopy" = "f[canopy]",
                              "klight" = "k",
                              "vC" = "v[C]",
                              "Cseedrain" = "seedrain",
                              "CR_b" = "CR[b]",
                              "log10nbs0" = "n[s]",
                              "g1" = "g[1]",
                              "m1" = "wsg[lim]"
  ),
  type = factor(recode(parameter, 
                       "m" = "Mortality",
                       "CR_a" = "Crown allometry",
                       "phi" = "Leaf ecophysiology",
                       "fallocwood" = "Carbon allocation",
                       "falloccanopy" = "Carbon allocation",
                       "klight" = "Leaf ecophysiology",
                       "vC" = "Mortality",
                       "Cseedrain" = "Reproduction",
                       "CR_b" = "Crown allometry",
                       "log10nbs0" = "Reproduction",
                       "g1" = "Leaf ecophysiology",
                       "m1" = "Mortality"
  ))) |> dplyr::select(-parameter) |> 
  rename(parameter = parameter_i) |> 
  ggplot(aes(x = mu.star, y = sigma))+
  geom_abline(slope = 1,intercept = 0, linetype = "solid", color = "grey50") + 
  geom_abline(slope = 0.1,intercept = 0, linetype = "twodash", color = "grey50") +
  geom_abline(slope = 0.5,intercept = 0, linetype = "dashed", color = "grey50") +
  annotate(
    geom = "text", x = 2.25, y = 4.8, 
    label = "Non-linear and/ or \n  interactions", hjust = 0, vjust = 1, size = 5, color = "grey50") +
  annotate(
    geom = "text", x = 3.75, y = 3.2, 
    label = "  Almost\nmonotonic", hjust = 0, vjust = 1, size = 5, color = "grey50") +
  annotate(
    geom = "text", x = 4.5, y = 1.5, 
    label = "Monotonic", hjust = 0, vjust = 1, size = 5, color = "grey50") +
  annotate(
    geom = "text", x = 5.3, y = 0.3, 
    label = "Linear", hjust = 0, vjust = 1, size = 5, color = "grey50") +
  geom_point(aes(color = type), size = 2) +
  geom_point(size = 2) +
  geom_label_repel(aes(label = parameter,fill = type), color = "black",parse = TRUE, size = 4.5,
                   box.padding = unit(0.8, "lines"),
                   point.padding = unit(0.8, "lines"),show.legend = FALSE, direction = "both",min.segment.length = 0.1) + 
  scale_color_grey(start = 0.6,end = 1,name = "Processus type")+
  scale_fill_grey(start = 0.6,end = 1) +
  ylim(0.1,NA) + xlim(0.1,NA) +
  labs( x = expression(Absolute~mean~of~elementary~effect ~ mu * "*" ~(unitless)),
        y = expression(Variance~of~elementary~effect~sigma~(unitless))) +
  theme_bw()+
  theme(text = element_text(size = 14))

ggsave(plot = Morris_fig,filename = "./figures/Morris_fig.png",device = "png",width = 10,height = 10,dpi = 1000)
```

![**Figure 1:** Sensitivity of TROLL global parameters using Morris analysis. 12 global parameters of TROLL were tested. The level of grey of the label indicates parameters implied in the same processus (from dark grey to white respectively : carbon allocation, crown allometry, leaf ecophysiology, mortality and reproduction). The x-axis represent represent the absolute mean of elementary effect 𝞵\* and the y-axis represents the variance of elementary effect 𝛔.](figures/Morris_fig.png)

The global outputs sensitivity is summarised in the figure 1 for each Troll model parameters with its parameters of elementary effect distribution : the absolute mean ($\mu^{*}$) and standard-error ($\sigma$).

A high $\mu^{*}$ indicates a factor with a heavy overall influence on model outputs; a high $\sigma$ indicates heterogeneity of the sensitivity across the parameter space, which could indicate non-linearities or interactions with other parameters (over the solid line). A high $\mu^{*}$ also tends to produce high $\sigma$, so should be interpreted relative to $\mu^{*}$.

To help the analysis, the three lines dividing the space provide the type of relation according to the ratio $\sigma/\mu^{*}$:

-   linear if $\sigma/\mu^{*} < 0.1$ ;

-   monotonic if $0.1<\sigma/\mu^{*}<0.5$;

-   ;almost monotonic if $0.5<\sigma/\mu^{*}<1$;

-   non-linear and/ or with interactions if $\sigma/\mu^{*}>1$.

We can observe our results are in agreement with @Marechaux2017 and @fisherInferringStructureDynamics2019, highlighting TROLL sensitivity to the parameters $CR_{a}$ of crown radius - diameter at 1.30m height (DBH) relationship, fraction of Net Primary Production ($NPP$) allocated in canopy $f_{canopy}$ and apparent quantum yield for C fixation $\Phi$, which are implied respectively in crown allometry, carbon allocation and photosynthesis processes.

### Variance-based analyses

Variance-based sensitivity analyses use the variance to describe the model output uncertainty. In this framework, the variance of the output of the model is decomposed into fractions which can be attributed to inputs or sets of inputs. The percent of variance attributed to an input can be interpreted directly as a sensibility index.

Initially described by Sobol, the decomposition is commonly summarised into three order of indices :

-   the first order indices ($S_{i}$) represents the marginal impact of an input $i$ on the output of interest;

-   the second order indices ($S_{ij}$) represents the interacting impact of an input $i$ jointly with an input $j$ ($i \neq j$) on the output of interest;

-   the total order indices ($T_{i}$) represents the overall impact of an input $i$ jointly with all the interaction on the output of interest.

To process these indices, we use the `sensobol` package and speed-up the computation by using the Azzani formula of indices [@puy2022].

```{r,fig.height=10,fig.width=10,eval=FALSE,include=TRUE}

load("./data/rcontrollTROLL_calib_1000x10LHS_600y.rda")
N <- 2^10
k <- 8
params <- calib_dataset$params[c(1:9,11:13)]
R <- 10^3
type <- "percent"
first <- total <- "azzini"
conf <- 0.95
order <- "second"
matrices <- c("A", "B", "AB", "BA")
mat <- sobol_matrices(matrices = matrices, N = N, params = params,
                      order = order, type = "LHS")

X <- cbind(mat[,1:9], 
           matrix(0.5,nrow =dim(mat)[1],ncol = 1),
           mat[,10:12],
           matrix(0.5,nrow =dim(mat)[1],ncol = 2))

Y <- matrix(c(scale(predict(calib_dataset$GPmodels$MeanAgb$mod.MeanAgb,X)$mean),
              scale(predict(calib_dataset$GPmodels$MeanSum10$mod.MeanSum10,X)$mean),
              scale(predict(calib_dataset$GPmodels$MeanSum30$mod.MeanSum30,X)$mean),
              scale(predict(calib_dataset$GPmodels$MeanGpp$mod.MeanGpp,X)$mean)), 
            ncol = 4, byrow = FALSE)


ind <- sobol_indices(matrices = matrices, Y = Y[,3], N = N, params = params,
                     first = first, total = total, order = order, boot = TRUE, 
                     R = R,
                     parallel = "no", type = type, conf = conf)

ind.dummy <- sobol_dummy(Y = Y[,3], N = N, params = params, boot = TRUE,
                         R = R)

```

```{r eval=FALSE, include=TRUE}
cols <- colnames(ind$results)[1:5]
ind$results[, (cols) := round(.SD, 3), .SDcols = (cols)]
val_sens <- ind$results |> 
  as_tibble() |> 
  mutate(param_sens = sub(pattern = '\u002E',replacement = " ",x = parameters,fixed = TRUE)) |> 
  separate(param_sens, into = c("from","to"),fill = "right",remove = TRUE,sep = "\\s") |> 
  mutate(sig = if_else(low.ci > 0 | sensitivity != "Sij", TRUE,FALSE),
         original = if_else(original<=0, 0, original))

val_sens$original[val_sens$sig == FALSE] <- NA

ST_sens <- val_sens |> as_tibble() |> 
  dplyr::select(original,parameters,sensitivity) |> 
  filter(sensitivity != "Sij") |> 
  mutate(parameter_i = recode(parameters, 
                              "m" = "m[0]",
                              "CR_a" = "CR[a]",
                              "phi" = "Phi",
                              "fallocwood" = "f[wood]",
                              "falloccanopy" = "f[canopy]",
                              "klight" = "k",
                              "vC" = "v[C]",
                              "Cseedrain" = "seedrain",
                              "CR_b" = "CR[b]",
                              "log10nbs0" = "n[s]",
                              "g1" = "g[1]",
                              "m1" = "wsg[lim]"
  ),type = as.factor(recode(parameters, 
                                    "m" = "Mortality",
                                    "CR_a" = "Crown allometry",
                                    "phi" = "Leaf ecophysiology",
                                    "fallocwood" = "Carbon allocation",
                                    "falloccanopy" = "Carbon allocation",
                                    "klight" = "Leaf ecophysiology",
                                    "vC" = "Mortality",
                                    "Cseedrain" = "Reproduction",
                                    "CR_b" = "Crown allometry",
                                    "log10nbs0" = "Reproduction",
                                    "g1" = "Leaf ecophysiology",
                                    "m1" = "Mortality"
  ))) |> spread(key = sensitivity, value = original)


graph_sens <- val_sens |> filter(sensitivity == "Sij") |> 
  dplyr::select(from,to,original,sig) |> 
  rename(weight = original) |> 
  tidygraph::as_tbl_graph() |> 
  left_join(ST_sens, by = c("name" = "parameters")) |> 
  mutate(Si_dummy = ind.dummy$original[1],
         Ti_dummy = ind.dummy$original[2],
         sobol = paste0("Si: ", ifelse(is.na(Si*100),0,if_else(Si > Si_dummy, paste0(Si*100,"*"), paste0(Si*100)) ), 
                        " %\n","Ti: ", ifelse(is.na(Ti*100),0,if_else(Ti > Ti_dummy, paste0(Ti*100,"*"), paste0(Ti*100)) )," %"),) |> 
  arrange(type)

# plot_scatter(data = mat, N = N, Y = Y[,1], params = params, method = "bin")
# plot(ind, dummy = ind.dummy)

ply <- ggraph(graph_sens, layout = 'linear', circular = TRUE) + 
  geom_edge_arc(aes(width  = weight*100),alpha = 0.65) + 
  geom_node_point(shape = 21, aes(size = Ti*100), fill = "black") +
  geom_node_point(shape = 21, aes(size = Si*100,fill = type )) +
  theme_graph() + theme(legend.position="right",legend.box = "vertical")+
  scale_size(range = c(0,10),name = "1st (Si) & Total (Ti)\nSobol indices (%)") +
  scale_edge_width_continuous(range = c(0.1,3),name = "2nd (Sij)\nSobol indices (%)") +
  scale_fill_grey(start = 0.5,end = 0.8,name = "Processus\ntype") +
  scale_edge_radius(range = c(0,10)) + 
  coord_fixed(xlim = c(-1.4, 1.4), ylim = c(-1.4, 1.4)) +
  ggtitle("Variance-based analysis of TROLL model","Number of tree with a diameter at 1.30m height over 30 cm (N30)")

  

graph_ply <- ply + geom_node_text(aes(label = parameter_i),nudge_x = ply$data$x * 0.32, nudge_y = ply$data$y * 0.32,
                 parse = TRUE,size = 6,check_overlap = FALSE) +
   geom_node_text(aes(label = sobol),parse = FALSE,
                  nudge_x = ply$data$x * 0.33 , nudge_y = ply$data$y * 0.33-0.15,
                  size = 4,check_overlap = FALSE) 

ggsave(graph_ply,filename = "./figures/graph_sens_N30.png",height = 10,width = 10,dpi = 300,device = "png")
```

![**Figure B:** Sensitivity of TROLL global parameters using Sobol analysis for the number of tree with a diameter at 1.30m height over 30 cm ($N_{30}$). 12 global parameters of TROLL were tested (next to the dots). The level of grey of the label indicates parameters implied in the same processus (from dark grey to white respectively : carbon allocation, crown allometry, leaf ecophysiology, mortality and reproduction). The size of the dot indicates the percentage of the effet. The inner dot represent the first order index $\left( S_{i}\right)$ and the outer dot represent the total order $\left( T_{i}\right)$. The star next to the index indicates a significant effect ($p<0.05$) compared to a dummy variable. The width of arc joining the edges represents the strength of the second order index $\left( S_{ij}\right)$. Only significant arcs are represented.

](figures/graph_sens_N30.png)

We can observe the results of the Sobol analysis for the number of tree with a diameter at 1.30m height over 30 cm ($N_{30}$) in Figure 2.  The result highlights TROLL sensitivity to the fraction of Net Primary Production allocated in canopy $f_{canopy}$  (marginal effect $S_i$ : 37.4%, total effect $T_i$:  51.1%), the parameters $CR_a$ of crown radius - diameter at 1.30m height relationship (marginal effect $S_i$ : 4.6%, total effect $T_i$:  23.6%), and apparent quantum yield for C fixation $\Phi$ (marginal effect $S_i$ : 9.8%, total effect $T_i$:  18.4%), which are implied respectively in crown allometry, carbon allocation and photosynthesis processes. 

However, we can distinguish two type of contribution to the output variance: the first type is represented by $f_{canopy}$ which have a heavy marginal impact and few interactions with other variables (illustrated by the absence of arc connected to its node); the second type is represented by $CR_{a}$ which has an average marginal impact but interacts with many other variables (illustrated by the multiple arc connected to its node) and gets a heavy total impact through them. 

Especially on the parameter $CR_{a}$, the meaning of the high sensitivity on $N_{30}$ (i.e. big trees) can be discussed through ecological processes leading to the observed forest structure. Previous studies like @fisherInferringStructureDynamics2019 showed an impact of $CR_{a}$ on crown packing, forest structure and Above Ground Biomass of the stand. However, the contribution linked to interactions like $CR_{a}$  is often neglected during parametrization due to limited computation resources. 

# Conclusion

In the present study, we demonstrated the use of rcontroll in combination with the R ecosystem for rapid sensitivity analysis of 12  global parameters of the TROLL model. 

The Morris analysis shedded light on the most influential global parameters in a qualitative approach. The Sobol analysis further stressed the impact of non-trivial interactions of inputs resulting in nonlinear outputs. 

An efficient parameterisation process should be based on such calibration and take into account the interactions between the parameters, which are usually neglected.

# References
