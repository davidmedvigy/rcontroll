---
title: "Sensitivity analysis of the TROLL model in French Guiana"
output: 
  bookdown::html_document2:
    number_sections: false  
    toc: true
    toc_float: yes
  bookdown::word_document2:
    reference_docx: ./template/template.docx
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: no
linestretch: 1.5
csl: bibliography/mee.csl
bibliography: bibliography/library.bib
link-citations: yes
---
Guillaume Salzet$^{1,2}$

*$^1$ INRAE, UMR BETA, 54042 Nancy, France;*
*$^2$ INRAE, UMR EcoFoG (Agroparistech, Cirad, CNRS, Université des Antilles, Université de la Guyane), Campus Agronomique, 97310 Kourou, French Guiana;*

# Introduction

Forest modelling aims to reproduce at a given scale of space and time emergent properties from sub-entities. Classically these entities in gap-models are cohorts of trees or for D(G)VM these are representative plant functional types. The underlying hypothesis is small scale interaction between entities can reproduce global patterns. In case of TROLL this hypothesis is furthermore implied with the use of individual ecophysiological processes. 

However, all this models rely on complex implementation and use high level of resources (time of computation) to provide results at their designed scale. Working with such complex models create challenges :
 * Simulations are time consuming and require the use of High Performance Computers when replicates are needed;
 * Model calibration are very complicated due to unpredictability of behaviour's model. This task need two steps to achieve calibration : a sensitivity analysis to select adapted parameters and a model inversion to selection which parameters of the model are more likely to produce observed outputs;
 * Model prediction need to assess uncertainties produced by the model. This goal imply to select calibration methods that allow to use calibrated-model in a reverse and forward uncertainty propagation.
 
We decide to interface TROLL through rcontroll and realize a first step for local calibration of the model : the sensitivity analysis.
Using Morris analysis we retrieved an overview of the most influential parameters. Though the computation of Sobol indexes for each summarized outputs we could separate marginal and interactions contribution for each parameters on model's outputs.
 
# Materials and methods

To illustrate 

* calibration function:

```{r calibration functions}
source("SI5_calibration_functions.R")

ls()
```




# Results

```{r Standard_LHS, echo=FALSE}
library(tidyverse)
library(kableExtra)
parameters <- c("klight","phi","g1","fallocwood","falloccanopy","m","vC","Cseedrain","log10nbs0","Hmaxcor","CR_a","CR_b","m1","DBHmaxcor","ahCorr")
lower <- c(0.5,4E-2,2,1E-2,1E-2,1E-2,1E-2,1E2,0,0.8,1.5,0.4,1,0.8,0.8)
upper = c(0.95,9E-2,5,1,1,0.05,0.15,1E5,3,1.2,3,0.8,1.2,1.2,1.2) 
global_parameters_boundaries <- data.frame("parameter" = parameters,"lower" = lower,
"upper" = upper)

global_parameters_boundaries %>%
  kbl(caption = "a priori ranges of parameters and correction factor") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "float_right")
```

```{r data_LHS, echo=FALSE, , echo=FALSE}
library(rcontroll)
library(tidyverse)
library(raster)
library(doSNOW)

LHS_design <- Generate_LHS_Autocalib(nsim = 500,nreplicat = 10,paramLHS = global_parameters_boundaries,Nyears = 600,Nsampling = 100)

Generated_parameters <- Generate_parameters_autocalib(LHS_design = LHS_design)

corrplot::corrplot(corr = cor(LHS_design$X))
```


```{r eval=FALSE, include=TRUE}
calib_dataset <- autocalibGP(Generated_parameters = Generated_parameters,
                             PATH = getwd(),
                             ncores_sim = 100,
                             ncores = 50,
                             NiterHetGP = NULL,
                             initj = 1,Jrefresh = 25,
                             GPComputation = TRUE)
```

```{r eval=FALSE, include=TRUE}
library(sensitivity)

morrisOut <- morris(
  model = NULL,
  factors = calib_dataset$params,
  r = 500,
  design = list(type = "oat", levels = 20, grid.jump = 3),
  binf = 0,
  bsup = 1,
  scale = FALSE)

Y <- matrix(c(predict(calib_dataset$GPmodels$RateDBH$mod.RateDBH,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanAgb$mod.MeanAgb,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanSum1$mod.MeanSum1,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanSum10$mod.MeanSum10,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanSum30$mod.MeanSum30,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanGpp$mod.MeanGpp,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanNpp$mod.MeanNpp,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanBa10$mod.MeanBa10,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanHill$mod.MeanHill,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$MeanRao$mod.MeanRao,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$Hmean$mod.Hmean,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$Lambda1ter$mod.Lambda1ter,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$VolECMP$mod.VolECMP,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$VolECMPS$mod.VolECMPS,morrisOut[['X']])$mean,
              predict(calib_dataset$GPmodels$GmDBH$mod.GmDBH,morrisOut[['X']])$mean), ncol = 15, byrow = FALSE)

tell(morrisOut,Y)

# summarise the moris output
morrisOut.df <- data.frame(
  parameter = calib_dataset$params,
  mu.star = apply(abs(morrisOut$ee), 2, mean, na.rm = T),
  sigma = apply(morrisOut$ee, 2, sd, na.rm = T)
) %>%
  arrange( mu.star )


```

```{r}
load("~/Nextcloud/Model/TROLL/datasets/rcontrollTROLL_calib_1000x10LHS_600y.rda")
```

```{r, fig.width=10,fig.height=10}
morrisOut.df %>%
  gather(variable, value, -parameter) %>%
  mutate(parameter = recode(parameter, 
                            "m" = "m[0]",
                            "CR_a" = "CR[a]",
                            "phi" = "Phi",
                            "fallocwood" = "f[wood]",
                            "falloccanopy" = "f[canopy]",
                            "klight" = "k",
                            "vC" = "v[C]",
                            "Cseedrain" = "seedrain",
                            "CR_b" = "CR[b]",
                            "ahCorr" = "a[h]",
                            "log10nbs0" = "log[10](n[s])",
                            "g1" = "g[1]",
                            "Hmaxcor" = "H[max]",
                            "m1" = "wsg[lim]",
                            "DBHmaxcor" = "DBH[max]"
                            )) %>% 
  ggplot(aes(reorder(parameter, value), value, fill = variable), color = NA)+
  geom_bar(position = position_dodge(), stat = 'identity') +
  scale_fill_brewer("", labels = c('mu.star' = expression(mu * "*"), 'sigma' = expression(sigma)), palette="Dark2") +
  coord_flip() +
  theme(
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(), 
    axis.text.y = element_text(size = 12),
    axis.title = element_blank(),
    legend.position = c(0.80, 0.50), legend.justification = c(0.05,0.95)
  ) + 
  scale_x_discrete(labels = scales::parse_format()) +
  scale_y_continuous(expand = c(0, 0)) + xlab("") + ylab("") +ggtitle("Morris analysis of TROLL model's parameters and species traits community correction factor") +
  theme_classic()
```

```{r eval=FALSE, include=TRUE}
library(tgp)
library(tidyverse)
library(doSNOW)
library(foreach)

load("~/Nextcloud/Model/TROLL/datasets/rcontrollTROLL_calib_1000x10LHS_600y.rda")
colnames(calib_dataset$XGP) <- paste0(colnames(calib_dataset$X),"_XG")

values <- cbind(calib_dataset$X,calib_dataset$XGP) %>% distinct()
index <- c(1,2,4,6,8,10,12,14,16,18,20,21,22,23,24)
cores <- length(index)
i <- NULL
sensitivity_all <- list()
for(i in index) {
  Ymean <- predict(calib_dataset$GPmodels[[i]][[2]],as.matrix(values[,16:30]))$mean
  sens <- tryCatchLog::tryCatchLog(tgp::sens(X = values[,1:15],Ymean, nn.lhs=1, model=bgp, verb=0))
  sensitivity_all <- c(sensitivity_all,list(sens))
    }

save(sensitivity_all,
     file = "~/Nextcloud/Model/TROLL/datasets/rcontroll_sens_1000x10LHS_600y.rda")
```

```{r}
library(tgp)
library(tidyverse)
library(patchwork)
load("~/Nextcloud/Model/TROLL/datasets/rcontroll_sens_1000x10LHS_600y.rda")
```


```{r Mean lambda_dbh10 SA, echo=FALSE}

Sens <- sensitivity_all$lambda_dbh10$sens
Total_sobol  <- Sens$T |> 
  as_tibble() |> 
  gather(key = "Variable", value = "Total_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = Total_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format(),)+
  guides(fill = "none")+
  ggtitle("B.2.",subtitle = "Total order Sobol sensitivity indices")+
  theme_bw()

st_sobol  <- Sens$S |> 
  as_tibble() |> 
  gather(key = "Variable", value = "st_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = st_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+ 
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format())+
  guides(fill = "none")+
  ggtitle("B.1.",subtitle = "1st order Sobol sensitivity indices")+
  theme_bw()

main_effects  <- Sens$ZZ.mean |> 
  as_tibble() |> 
  gather(key = "Variable", value = "main_effect") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  mutate(scaled_x = c(mean0.range1(Sens$Xgrid)$X)) |> 
  ggplot(aes(x = scaled_x, y = main_effect, color = Variable)) +
  geom_hline(yintercept = 0, color = "black", linetype ="dashed") +
  geom_line() +
  xlab("Scaled effect") + ylab("Response")+
  scale_color_discrete(labels = scales::parse_format())+
  ggtitle("A.",subtitle = "Main Effects")+
  theme_bw()




(main_effects+ plot_layout(guides = 'auto') | (st_sobol+ plot_layout(guides = 'auto')) / (Total_sobol+ plot_layout(guides = 'auto')))  +
  plot_layout(guides = 'collect') + plot_annotation(title = "Diameter distribution - Exponential parameter",subtitle = "Sobol indices analysis")

```

```{r Mean AGB SA, echo=FALSE}

Sens <- sensitivity_all$agb_mean$sens
Total_sobol  <- Sens$T |> 
  as_tibble() |> 
  gather(key = "Variable", value = "Total_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = Total_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format(),)+
  guides(fill = "none")+
  ggtitle("B.2.",subtitle = "Total order Sobol sensitivity indices")+
  theme_bw()

st_sobol  <- Sens$S |> 
  as_tibble() |> 
  gather(key = "Variable", value = "st_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = st_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+ 
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format())+
  guides(fill = "none")+
  ggtitle("B.1.",subtitle = "1st order Sobol sensitivity indices")+
  theme_bw()

main_effects  <- Sens$ZZ.mean |> 
  as_tibble() |> 
  gather(key = "Variable", value = "main_effect") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  mutate(scaled_x = c(mean0.range1(Sens$Xgrid)$X)) |> 
  ggplot(aes(x = scaled_x, y = main_effect, color = Variable)) +
  geom_hline(yintercept = 0, color = "black", linetype ="dashed") +
  geom_line() +
  xlab("Scaled effect") + ylab("Response")+
  scale_color_discrete(labels = scales::parse_format())+
  ggtitle("A.",subtitle = "Main Effects")+
  theme_bw()




(main_effects+ plot_layout(guides = 'auto') | (st_sobol+ plot_layout(guides = 'auto')) / (Total_sobol+ plot_layout(guides = 'auto')))  +
  plot_layout(guides = 'collect') + plot_annotation(title = "Mean AGB",subtitle = "Sobol indices analysis")

```


```{r Mean N10 SA, echo=FALSE}

Sens <- sensitivity_all$abu10_mean$sens
Total_sobol  <- Sens$T |> 
  as_tibble() |> 
  gather(key = "Variable", value = "Total_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = Total_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format(),)+
  guides(fill = "none")+
  ggtitle("B.2.",subtitle = "Total order Sobol sensitivity indices")+
  theme_bw()

st_sobol  <- Sens$S |> 
  as_tibble() |> 
  gather(key = "Variable", value = "st_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = st_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+ 
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format())+
  guides(fill = "none")+
  ggtitle("B.1.",subtitle = "1st order Sobol sensitivity indices")+
  theme_bw()

main_effects  <- Sens$ZZ.mean |> 
  as_tibble() |> 
  gather(key = "Variable", value = "main_effect") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  mutate(scaled_x = c(mean0.range1(Sens$Xgrid)$X)) |> 
  ggplot(aes(x = scaled_x, y = main_effect, color = Variable)) +
  geom_hline(yintercept = 0, color = "black", linetype ="dashed") +
  geom_line() +
  xlab("Scaled effect") + ylab("Response")+
  scale_color_discrete(labels = scales::parse_format())+
  ggtitle("A.",subtitle = "Main Effects")+
  theme_bw()




(main_effects+ plot_layout(guides = 'auto') | (st_sobol+ plot_layout(guides = 'auto')) / (Total_sobol+ plot_layout(guides = 'auto')))  +
  plot_layout(guides = 'collect') + plot_annotation(title = "Tree abundance with DBH > 10cm",subtitle = "Sobol indices analysis")

```

```{r Mean N30 SA, echo=FALSE}

Sens <- sensitivity_all$abu30_mean$sens
Total_sobol  <- Sens$T |> 
  as_tibble() |> 
  gather(key = "Variable", value = "Total_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = Total_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format(),)+
  guides(fill = "none")+
  ggtitle("B.2.",subtitle = "Total order Sobol sensitivity indices")+
  theme_bw()

st_sobol  <- Sens$S |> 
  as_tibble() |> 
  gather(key = "Variable", value = "st_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = st_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+ 
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format())+
  guides(fill = "none")+
  ggtitle("B.1.",subtitle = "1st order Sobol sensitivity indices")+
  theme_bw()

main_effects  <- Sens$ZZ.mean |> 
  as_tibble() |> 
  gather(key = "Variable", value = "main_effect") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  mutate(scaled_x = c(mean0.range1(Sens$Xgrid)$X)) |> 
  ggplot(aes(x = scaled_x, y = main_effect, color = Variable)) +
  geom_hline(yintercept = 0, color = "black", linetype ="dashed") +
  geom_line() +
  xlab("Scaled effect") + ylab("Response")+
  scale_color_discrete(labels = scales::parse_format())+
  ggtitle("A.",subtitle = "Main Effects")+
  theme_bw()




(main_effects+ plot_layout(guides = 'auto') | (st_sobol+ plot_layout(guides = 'auto')) / (Total_sobol+ plot_layout(guides = 'auto')))  +
  plot_layout(guides = 'collect') + plot_annotation(title = "Tree abundance with DBH > 30cm",subtitle = "Sobol indices analysis")

```

```{r Mean GPP SA, echo=FALSE}

Sens <- sensitivity_all$gpp_mean$sens
Total_sobol  <- Sens$T |> 
  as_tibble() |> 
  gather(key = "Variable", value = "Total_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = Total_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format(),)+
  guides(fill = "none")+
  ggtitle("B.2.",subtitle = "Total order Sobol sensitivity indices")+
  theme_bw()

st_sobol  <- Sens$S |> 
  as_tibble() |> 
  gather(key = "Variable", value = "st_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = st_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+ 
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format())+
  guides(fill = "none")+
  ggtitle("B.1.",subtitle = "1st order Sobol sensitivity indices")+
  theme_bw()

main_effects  <- Sens$ZZ.mean |> 
  as_tibble() |> 
  gather(key = "Variable", value = "main_effect") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  mutate(scaled_x = c(mean0.range1(Sens$Xgrid)$X)) |> 
  ggplot(aes(x = scaled_x, y = main_effect, color = Variable)) +
  geom_hline(yintercept = 0, color = "black", linetype ="dashed") +
  geom_line() +
  xlab("Scaled effect") + ylab("Response")+
  scale_color_discrete(labels = scales::parse_format())+
  ggtitle("A.",subtitle = "Main Effects")+
  theme_bw()




(main_effects+ plot_layout(guides = 'auto') | (st_sobol+ plot_layout(guides = 'auto')) / (Total_sobol+ plot_layout(guides = 'auto')))  +
  plot_layout(guides = 'collect') + plot_annotation(title = "Mean annual GPP",subtitle = "Sobol indices analysis")

```

```{r Mean Hill SA, echo=FALSE}

Sens <- sensitivity_all$hill_mean$sens
Total_sobol  <- Sens$T |> 
  as_tibble() |> 
  gather(key = "Variable", value = "Total_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = Total_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format(),)+
  guides(fill = "none")+
  ggtitle("B.2.",subtitle = "Total order Sobol sensitivity indices")+
  theme_bw()

st_sobol  <- Sens$S |> 
  as_tibble() |> 
  gather(key = "Variable", value = "st_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = st_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+ 
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format())+
  guides(fill = "none")+
  ggtitle("B.1.",subtitle = "1st order Sobol sensitivity indices")+
  theme_bw()

main_effects  <- Sens$ZZ.mean |> 
  as_tibble() |> 
  gather(key = "Variable", value = "main_effect") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  mutate(scaled_x = c(mean0.range1(Sens$Xgrid)$X)) |> 
  ggplot(aes(x = scaled_x, y = main_effect, color = Variable)) +
  geom_hline(yintercept = 0, color = "black", linetype ="dashed") +
  geom_line() +
  xlab("Scaled effect") + ylab("Response")+
  scale_color_discrete(labels = scales::parse_format())+
  ggtitle("A.",subtitle = "Main Effects")+
  theme_bw()




(main_effects+ plot_layout(guides = 'auto') | (st_sobol+ plot_layout(guides = 'auto')) / (Total_sobol+ plot_layout(guides = 'auto')))  +
  plot_layout(guides = 'collect') + plot_annotation(title = "Hill order 1",subtitle = "Sobol indices analysis")

```

```{r Mean Vol ECMP SA, echo=FALSE}

Sens <- sensitivity_all$Vol_ECMP$sens
Total_sobol  <- Sens$T |> 
  as_tibble() |> 
  gather(key = "Variable", value = "Total_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = Total_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format(),)+
  guides(fill = "none")+
  ggtitle("B.2.",subtitle = "Total order Sobol sensitivity indices")+
  theme_bw()

st_sobol  <- Sens$S |> 
  as_tibble() |> 
  gather(key = "Variable", value = "st_sobol") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  ggplot(aes(x = Variable, y = st_sobol,fill = Variable)) +geom_boxplot() + 
  xlab("") + ylab("")+ 
  scale_fill_discrete(labels = scales::parse_format())+
  scale_x_discrete(labels = scales::parse_format())+
  guides(fill = "none")+
  ggtitle("B.1.",subtitle = "1st order Sobol sensitivity indices")+
  theme_bw()

main_effects  <- Sens$ZZ.mean |> 
  as_tibble() |> 
  gather(key = "Variable", value = "main_effect") |> 
  mutate(parameter = factor(recode(Variable,"V6" = "m[0]",
                            "V11" = "CR[a]",
                            "V2" = "Phi",
                            "V4" = "f[wood]",
                            "V5" = "f[canopy]",
                            "V1" = "k",
                            "V7" = "v[C]",
                            "V8" = "seedrain",
                            "V12" = "CR[b]",
                            "V15" = "a[h]",
                            "V9" = "log[10](n[s])",
                            "V3" = "g[1]",
                            "V10" = "H[max]",
                            "V13" = "wsg[lim]",
                            "V14" = "DBH[max]"
                            )))  |> 
  mutate(Variable = factor(parameter, levels = c("k","Phi","g[1]","f[wood]","f[canopy]",
                                                  "m[0]","v[C]","seedrain","log[10](n[s])",
                                                  "H[max]","CR[a]","CR[b]","wsg[lim]",
                                                  "DBH[max]","a[h]"))) |> 
  mutate(scaled_x = c(mean0.range1(Sens$Xgrid)$X)) |> 
  ggplot(aes(x = scaled_x, y = main_effect, color = Variable)) +
  geom_hline(yintercept = 0, color = "black", linetype ="dashed") +
  geom_line() +
  xlab("Scaled effect") + ylab("Response")+
  scale_color_discrete(labels = scales::parse_format())+
  ggtitle("A.",subtitle = "Main Effects")+
  theme_bw()




(main_effects+ plot_layout(guides = 'auto') | (st_sobol+ plot_layout(guides = 'auto')) / (Total_sobol+ plot_layout(guides = 'auto')))  +
  plot_layout(guides = 'collect') + plot_annotation(title = "ECMP Volume",subtitle = "Sobol indices analysis")

```


# Discussion

# References